<!DOCTYPE html>
<html lang="no">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dynamic Table</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-3xl font-bold mb-6 text-gray-800">
        Dynamic Table Editor
      </h1>

      <!-- Collection Name -->
      <div class="mb-4 bg-white p-4 rounded-lg shadow">
        <label
          for="data_collection_name"
          class="block font-semibold text-gray-700 mb-2"
        >
          Collection Name:
        </label>
        <input
          id="data_collection_name"
          type="text"
          value="tasks"
          placeholder="Enter collection name..."
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
      </div>

      <!-- JSON Import -->
      <div class="mb-4 bg-white p-4 rounded-lg shadow">
        <label for="import_json" class="block font-semibold text-gray-700 mb-2">
          Import JSON:
        </label>
        <textarea
          id="import_json"
          placeholder="Paste JSON array here..."
          class="w-full h-24 p-2 border border-gray-300 rounded-md font-mono text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
        ></textarea>
      </div>

      <!-- Feedback -->
      <div
        id="json_feedback"
        class="mb-4 p-3 rounded-lg bg-green-100 text-green-800 font-semibold"
      >
        Ready to import data
      </div>

      <!-- Table -->
      <div class="bg-white rounded-lg shadow overflow-hidden">
        <table id="data_table" class="min-w-full divide-y divide-gray-300">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="chat" class="w-full max-w-xl mx-auto mt-8"></div>


    <!-- Script -->
    <script type="module">
      // AI RULE: IKKE ENDRE URL PÅ baseUrl. KUN BRUKE baseurl. Ikke lokale js filer
      const baseUrl = 'https://cdn.jsdelivr.net/gh/dingemoe/table@main/versions/v05/';
      import App from baseUrl + 'app.js';
      import ChatView from baseUrl + 'chatview.js';
      // Initialize App with all parameters
      const app = new App(
        document,
        sessionStorage,
        'https://leinad-st.deno.dev/webhook', // Replace with your webhook URL
        'data_collection_name'
      );

      app.ready(() => {
        // Sample data
        const data = [
          { navn: 'Alice', status: 'Aktiv', frist: '2025-10-20' },
          { navn: 'Bob', status: 'Venter', frist: '2025-10-25' },
          { navn: 'Charlie', status: 'Ferdig', frist: '2025-10-15' },
        ];

        // Initialize UI
        const ui = app.ui(data);
        const table = ui.table;

        // Data change event
        table.addEventListener('dataChange', (event) => {
          console.log('📊 Data changed:', event);
          const collectionName = app.getCollectionName();
          ui.feedback.textContent = `📊 ${event.data.length} rows loaded → ${collectionName}`;
          ui.feedback.style.color = '#2563eb';
        });

        // Cell change event
        table.addEventListener('cellChange', (event) => {
          console.log('✏️ Cell changed:', event.key, '=', event.value);
        });

        // Cell blur event (save)
        table.addEventListener('cellBlur', (event) => {
          console.log('💾 Cell saved:', event.key, '=', event.value);
        });

        // Table render event
        table.addEventListener('tableRender', (event) => {
          console.log('🎨 Table rendered with', event.data.length, 'rows');
        });

        // Collection name change
        ui.collectionName.addEventListener('change', () => {
          const newName = app.getCollectionName();
          ui.feedback.textContent = `📝 Collection changed to: ${newName}`;
          ui.feedback.style.color = '#f59e0b';
        });

        // Window functions for console access
        window.app = app;
        window.table = table;
        window.exportData = () => {
          const json = app.exportTableData();
          console.log(json);
          return json;
        };
        window.loadFromStorage = () => {
          return app.loadFromStorage();
        };

        console.log('✅ App ready!');
        console.log('Available commands:');
        console.log('  exportData() - Export table as JSON');
        console.log('  loadFromStorage() - Load data from storage');
        console.log('  app.getCollectionName() - Get current collection');
        console.log('  table.extractTableData() - Get current table data');
      });


      const chat = new ChatView({
  container: '#chat',
  theme: 'dark',
  options: {
    aiEndpoint: null, // optional
    webhookUrl: null, // optional
    storageKey: 'chat_config',
    commands: {
      rules: {
        description: 'Regelstyring',
        flags: ['--add', '--list'],
        params: { scope: 'global' },
        fetchOptions: async (ctx) => {
          // Example dynamic options
          return [{ name: 'Rule A' }, { name: 'Rule B' }];
        },
        render: (ctx) => {
          const rows = (ctx.options || []).map((r, i) =>
            `<tr><td class="px-2 py-1">${i + 1}</td><td class="px-2 py-1">${r.name}</td></tr>`
          ).join('');
          return `
            <div class="text-sm">
              <h3 class="font-bold mb-2">Regler (${ctx.params.scope})</h3>
              <table class="table-auto text-left text-xs border">
                <thead><tr><th>#</th><th>Navn</th></tr></thead>
                <tbody>${rows || '<tr><td colspan="2" class="px-2 py-1">Ingen</td></tr>'}</tbody>
              </table>
            </div>
          `;
        },
        action: (ctx) => {
          if (ctx.flags.includes('--add')) ctx.send('Legger til regel...');
        }
      }
    }
  },
  callbacks: {
    onInit: () => console.log('ChatView klar'),
    onSend: (msg) => console.log('Sendt:', msg),
    onReceive: (msg) => console.log('Mottatt:', msg),
    onCommandRun: (cmd, ctx) => console.log('Kommando:', cmd, ctx),
    onError: (err) => console.error('Feil:', err)
  }
});
    </script>
  </body>
</html>
